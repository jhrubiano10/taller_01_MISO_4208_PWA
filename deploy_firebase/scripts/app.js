!function(){"use strict";function e(e,t){var o=n.transaction(e,t);return o.objectStore(e)}var t={isLoading:!0,visibleCards:{},selectedTimetables:[],spinner:document.querySelector(".loader"),cardTemplate:document.querySelector(".cardTemplate"),container:document.querySelector(".main"),addDialog:document.querySelector(".dialog-container")};document.getElementById("butRefresh").addEventListener("click",function(){t.updateSchedules()}),document.getElementById("butAdd").addEventListener("click",function(){t.toggleAddDialog(!0)}),document.getElementById("butAddCity").addEventListener("click",function(){var e=document.getElementById("selectTimetableToAdd"),n=e.options[e.selectedIndex],o=n.value,r=n.textContent;t.selectedTimetables||(t.selectedTimetables=[]),t.getSchedule(o,r),t.selectedTimetables.push({key:o,label:r}),t.saveSelectedTimes({key:o,label:r}),t.toggleAddDialog(!1)}),document.getElementById("butAddCancel").addEventListener("click",function(){t.toggleAddDialog(!1)}),t.toggleAddDialog=function(e){e?t.addDialog.classList.add("dialog-container--visible"):t.addDialog.classList.remove("dialog-container--visible")},t.updateTimetableCard=function(e){var n=e.key,o=(new Date(e.created),e.schedules),r=t.visibleCards[n];if(!r){var a=e.label.split(", "),l=a[0],s=a[1];r=t.cardTemplate.cloneNode(!0),r.classList.remove("cardTemplate"),r.querySelector(".label").textContent=l,r.querySelector(".subtitle").textContent=s,r.removeAttribute("hidden"),t.container.appendChild(r),t.visibleCards[n]=r}r.querySelector(".card-last-updated").textContent=e.created;for(var c=r.querySelectorAll(".schedule"),d=0;4>d;d++){var i=o[d],u=c[d];i&&u&&(u.querySelector(".message").textContent=i.message)}t.isLoading&&(t.spinner.setAttribute("hidden",!0),t.container.removeAttribute("hidden"),t.isLoading=!1)},t.getSchedule=function(e,n){var r="https://api-ratp.pierre-grimaud.fr/v3/schedules/"+e;"caches"in window&&caches.match(r).then(function(o){o&&o.json().then(function(o){console.log("DESDE LA CACHÉ"),t.updateTimetableCard({key:e,label:n,created:o._metadata.date,schedules:o.result.schedules})})});var a=new XMLHttpRequest;a.onreadystatechange=function(){if(a.readyState===XMLHttpRequest.DONE){if(200===a.status){var r=JSON.parse(a.response),l={};l.key=e,l.label=n,l.created=r._metadata.date,l.schedules=r.result.schedules,t.updateTimetableCard(l)}}else t.updateTimetableCard(o)},a.open("GET",r),a.send()},t.updateSchedules=function(){var e=Object.keys(t.visibleCards);e.forEach(function(e){t.getSchedule(e)})},t.saveSelectedTimes=function(t){var n,o=e(l,"readwrite");try{n=o.add(t)}catch(r){"DataCloneError"==r.name&&console.log("Error en DataCloneError")}n.onsuccess=function(){console.log("Insertion in DB successful")},n.onerror=function(){console.error("addPublication error",this.error)}};var n,o={key:"metros/1/bastille/A",label:"Bastille, Direction La Défense",created:"2017-07-18T17:08:42+02:00",schedules:[{message:"0 mn"},{message:"2 mn"},{message:"5 mn"}]},r="indexeddb-trainsparis",a=2,l="schedules",s=(function(){console.log("openDb ...");var e=indexedDB.open(r,a);e.onsuccess=function(){n=this.result,console.log("openDb DONE"),s()},e.onerror=function(e){console.error("openDb:",e.target.errorCode)},e.onupgradeneeded=function(e){console.log("openDb.onupgradeneeded");var t=e.currentTarget.result.createObjectStore(l,{keyPath:"id",autoIncrement:!0});t.createIndex("key","key",{unique:!1}),t.createIndex("label","label",{unique:!1})}}(),function(){var n,r=e(l,"readonly");n=r.count(),n.onsuccess=function(e){console.log("There are "+e.target.result+" record(s) in the object store.")},n.onerror=function(){console.error("add error",this.error)};var a=0;n=r.openCursor(),n.onsuccess=function(e){var l=e.target.result;l?(n=r.get(l.key),n.onsuccess=function(e){var n=e.target.result;t.selectedTimetables.push({key:n.key,label:n.label})},l.continue(),a++):(console.log("No more entries: ",a),0===a?(console.log("GUARDAR LA DATA EN INDEXDB"),t.updateTimetableCard(o),t.selectedTimetables=[{key:o.key,label:o.label}],t.saveSelectedTimes({key:o.key,label:o.label})):(console.log("DATA DE INDEXDB"),console.log(t.selectedTimetables),t.selectedTimetables.forEach(function(e){t.getSchedule(e.key,e.label)})))}});"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js").then(function(){console.log("Service Worker Registered")})}();